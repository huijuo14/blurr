name: Android CI with Debug  
  
on:  
  push:  
    branches: [ main, master ]  
  pull_request:  
    branches: [ main, master ]  
  
jobs:  
  build:  
    runs-on: ubuntu-latest  
    timeout-minutes: 60  
      
    steps:  
    - uses: actions/checkout@v4  
      
    - name: Set up JDK 17  
      uses: actions/setup-java@v3  
      with:  
        java-version: '17'  
        distribution: 'temurin'  
      
    - name: Setup Android SDK  
      uses: android-actions/setup-android@v2  
      
    - name: Cache Gradle packages  
      uses: actions/cache@v3  
      with:  
        path: |  
          ~/.gradle/caches  
          ~/.gradle/wrapper  
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}  
        restore-keys: |  
          ${{ runner.os }}-gradle-  
      
    - name: Grant execute permission for gradlew  
      run: chmod +x gradlew  
      
    - name: Debug - Show environment  
      run: |  
        echo "Java version: $(java -version)"  
        echo "Android SDK path: $ANDROID_HOME"  
        echo "Gradle version: $(./gradlew --version)"  
      
    - name: Validate required secrets  
      run: |  
        echo "ğŸ” Validating required secrets..."  
          
        # Check each required secret explicitly  
        if [ -z "${{ secrets.GEMINI_API_KEYS }}" ]; then  
          echo "âŒ Missing secret: GEMINI_API_KEYS"  
          exit 1  
        else  
          echo "âœ… Found secret: GEMINI_API_KEYS"  
        fi  
          
        if [ -z "${{ secrets.PICOVOICE_ACCESS_KEY }}" ]; then  
          echo "âŒ Missing secret: PICOVOICE_ACCESS_KEY"  
          exit 1  
        else  
          echo "âœ… Found secret: PICOVOICE_ACCESS_KEY"  
        fi  
          
        if [ -z "${{ secrets.GOOGLE_TTS_API_KEY }}" ]; then  
          echo "âŒ Missing secret: GOOGLE_TTS_API_KEY"  
          exit 1  
        else  
          echo "âœ… Found secret: GOOGLE_TTS_API_KEY"  
        fi  
          
        if [ -z "${{ secrets.TAVILY_API }}" ]; then  
          echo "âŒ Missing secret: TAVILY_API"  
          exit 1  
        else  
          echo "âœ… Found secret: TAVILY_API"  
        fi  
          
        if [ -z "${{ secrets.MEM0_API }}" ]; then  
          echo "âŒ Missing secret: MEM0_API"  
          exit 1  
        else  
          echo "âœ… Found secret: MEM0_API"  
        fi  
          
        echo "âœ… All critical secrets validated"  
      
    - name: Create local.properties with secrets and debug  
      run: |  
        echo "ğŸ“ Creating local.properties..."  
        echo "sdk.dir=$ANDROID_HOME" > local.properties  
          
        # Add all required API keys  
        echo "GEMINI_API_KEYS=${{ secrets.GEMINI_API_KEYS }}" >> local.properties  
        echo "PICOVOICE_ACCESS_KEY=${{ secrets.PICOVOICE_ACCESS_KEY }}" >> local.properties  
        echo "GOOGLE_TTS_API_KEY=${{ secrets.GOOGLE_TTS_API_KEY }}" >> local.properties  
        echo "TAVILY_API=${{ secrets.TAVILY_API }}" >> local.properties  
        echo "MEM0_API=${{ secrets.MEM0_API }}" >> local.properties  
        echo "GCLOUD_GATEWAY_URL=${{ secrets.GCLOUD_GATEWAY_URL }}" >> local.properties  
        echo "GCLOUD_GATEWAY_PICOVOICE_KEY=${{ secrets.GCLOUD_GATEWAY_PICOVOICE_KEY }}" >> local.properties  
        echo "GCLOUD_PROXY_URL=${{ secrets.GCLOUD_PROXY_URL }}" >> local.properties  
        echo "GCLOUD_PROXY_URL_KEY=${{ secrets.GCLOUD_PROXY_URL_KEY }}" >> local.properties  
        echo "REVENUE_CAT_PUBLIC_URL=${{ secrets.REVENUE_CAT_PUBLIC_URL }}" >> local.properties  
        echo "REVENUECAT_API_KEY=${{ secrets.REVENUECAT_API_KEY }}" >> local.properties  
          
        echo "âœ… local.properties created"  
        echo "ğŸ“‹ Contents (sanitized):"  
        cat local.properties | sed 's/=.*/=***HIDDEN***/'  
      
    - name: Debug - Verify Gradle configuration  
      run: |  
        echo "ğŸ” Verifying Gradle configuration..."  
        ./gradlew tasks --all | grep -E "(assemble|build)" | head -20  
        echo "ğŸ“Š Project info:"  
        ./gradlew projects  
      
    - name: Build with Gradle (Debug)  
      run: |  
        echo "ğŸš€ Starting build process..."  
        echo "â±ï¸ This may take 20-30 minutes for first build..."  
        ./gradlew assembleDebug --info --stacktrace  
      env:  
        GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.debug=true  
      
    - name: Debug - Check APK contents  
      if: always()  
      run: |  
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then  
          echo "âœ… APK built successfully"  
          echo "ğŸ“¦ APK info:"  
          ls -lh app/build/outputs/apk/debug/app-debug.apk  
          echo "ğŸ” Checking BuildConfig fields:"  
          unzip -p app/build/outputs/apk/debug/app-debug.apk classes.dex | strings | grep -E "(GEMINI_API_KEYS|PICOVOICE_ACCESS_KEY)" | head -5  
        else  
          echo "âŒ APK not found"  
          find app/build -name "*.apk" -ls || echo "No APKs found in build directory"  
        fi  
      
    - name: Upload APK  
      if: success()  
      uses: actions/upload-artifact@v4  
      with:  
        name: app-debug  
        path: app/build/outputs/apk/debug/app-debug.apk  
        retention-days: 30  
      
    - name: Upload build logs  
      if: failure()  
      uses: actions/upload-artifact@v4  
      with:  
        name: build-logs  
        path: |  
          app/build/logs/  
          .gradle/  
        retention-days: 7
