name: Android CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
    
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "GEMINI_API_KEYS=${{ secrets.GEMINI_API_KEYS }}" >> local.properties
        echo "GCLOUD_PROXY_URL=${{ secrets.GCLOUD_PROXY_URL }}" >> local.properties
        echo "GCLOUD_PROXY_URL_KEY=${{ secrets.GCLOUD_PROXY_URL_KEY }}" >> local.properties
    
    - name: Build with Gradle
      run: ./gradlew assembleDebug
    
    - name: Generate and Display SHA-1 Key
      run: |
        APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
        
        echo "ðŸ” Looking for APK at: $APK_PATH"
        
        if [ -f "$APK_PATH" ]; then
          echo "âœ… APK found successfully"
          
          # Method 1: Try to extract SHA-1 using keytool
          echo "ðŸ”‘ Extracting SHA-1 key from APK..."
          SHA1_KEY=$(keytool -printcert -jarfile "$APK_PATH" 2>/dev/null | grep -A1 "Certificate fingerprints" | grep "SHA1:" | awk '{print $2}')
          
          if [ -n "$SHA1_KEY" ]; then
            echo "=========================================="
            echo "âœ… SHA-1 KEY: $SHA1_KEY"
            echo "=========================================="
            echo "SHA1_KEY=$SHA1_KEY" >> $GITHUB_ENV
          else
            # Method 2: Alternative extraction method
            echo "âš ï¸  First method failed, trying alternative..."
            SHA1_KEY=$(keytool -list -printcert -jarfile "$APK_PATH" 2>/dev/null | grep "SHA1" | head -1 | awk '{print $NF}')
            
            if [ -n "$SHA1_KEY" ]; then
              echo "=========================================="
              echo "âœ… SHA-1 KEY (Method 2): $SHA1_KEY"
              echo "=========================================="
              echo "SHA1_KEY=$SHA1_KEY" >> $GITHUB_ENV
            else
              # Method 3: Use apksigner for newer Android builds
              echo "âš ï¸  Second method failed, trying apksigner..."
              SHA1_KEY=$(apksigner verify --print-certs "$APK_PATH" 2>/dev/null | grep "SHA-1" | head -1 | awk '{print $2}')
              
              if [ -n "$SHA1_KEY" ]; then
                echo "=========================================="
                echo "âœ… SHA-1 KEY (apksigner): $SHA1_KEY"
                echo "=========================================="
                echo "SHA1_KEY=$SHA1_KEY" >> $GITHUB_ENV
              else
                echo "âŒ Could not extract SHA-1 key from APK"
                echo "APK might not be signed or signing info is unavailable"
                
                # Show certificate info for debugging
                echo "ðŸ“„ Certificate information (for debugging):"
                keytool -printcert -jarfile "$APK_PATH" 2>/dev/null || echo "keytool failed"
                
                # List all APKs for debugging
                echo "ðŸ“ Available APK files:"
                find app/build/outputs -name "*.apk" -type f 2>/dev/null | while read file; do
                  echo "  - $file"
                done
              fi
            fi
          fi
        else
          echo "âŒ Error: APK file not found at $APK_PATH"
          echo "ðŸ“ Searching for APK files..."
          find . -name "*.apk" -type f 2>/dev/null | head -10
          echo "ðŸ“ Build outputs directory contents:"
          ls -la app/build/outputs/apk/ || true
          ls -la app/build/outputs/ || true
          exit 1
        fi
    
    - name: Display SHA-1 in Summary
      if: env.SHA1_KEY != ''
      run: |
        echo "## SHA-1 Key" >> $GITHUB_STEP_SUMMARY
        echo "**APK SHA-1:** \`$SHA1_KEY\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Use this SHA-1 for:" >> $GITHUB_STEP_SUMMARY
        echo "- Firebase configuration" >> $GITHUB_STEP_SUMMARY
        echo "- Google Maps API" >> $GITHUB_STEP_SUMMARY
        echo "- Google Sign-In" >> $GITHUB_STEP_SUMMARY
        echo "- Other Google services" >> $GITHUB_STEP_SUMMARY
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/app-debug.apk
        if-no-files-found: error
